<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Chiranjeevi Health Screening</title>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
		rel="stylesheet" />
	<link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="common-styles.css">

	<!-- No client-side MediaPipe needed ‚Äî all processing is backend -->
	<style>
		:root {
			/* --- MATERIAL 3 COLOR TOKENS (Blue Theme) --- */
			/* Backgrounds */
			--md-sys-color-surface: #FDFBFF;
			--md-sys-color-surface-container-low: #F0F4F8;
			--md-sys-color-surface-container: #EAEFF5;
			--md-sys-color-surface-container-high: #E2E7ED;

			/* Primary (Action) */
			--md-sys-color-primary: #0B57D0;
			--md-sys-color-on-primary: #FFFFFF;
			--md-sys-color-primary-container: #D3E3FD;
			--md-sys-color-on-primary-container: #041E49;

			/* Secondary (Tonal Elements) */
			--md-sys-color-secondary-container: #C2E7FF;
			--md-sys-color-on-secondary-container: #001D35;

			/* Error / Status */
			--md-sys-color-error: #D97706;
			/* Alert Amber instead of aggressive red */
			--md-sys-color-error-container: #FFEDD5;
			/* Lighter Amber container */
			--md-sys-color-on-error-container: #92400E;
			--md-sys-color-success-container: #C4EED0;
			--md-sys-color-on-success-container: #0F5223;

			/* Text */
			--md-sys-color-on-surface: #1B1B1F;
			--md-sys-color-on-surface-variant: #444746;
			--md-sys-color-outline: #747775;
			--md-sys-color-outline-variant: #C4C7C5;

			/* Layout values */
			--radius-large: 28px;
			--radius-medium: 16px;
			--radius-full: 999px;
			/* Stadium shape */
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Google Sans', 'Roboto', sans-serif;
			background: var(--md-sys-color-surface);
			color: var(--md-sys-color-on-surface);
			height: 100vh;
			width: 100vw;
			overflow: hidden;
			display: flex;
			gap: 16px;
		}

		/* ========================================= */
		/* LEFT PANEL: CAMERA                        */
		/* ========================================= */
		.camera-panel {
			flex: 1;
			position: relative;
			background: #000;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
			border-radius: var(--radius-large);
			/* M3 uses tonal difference, but black needs no border */
		}

		.camera-panel img {
			position: absolute;
			width: 100%;
			height: 100%;
			object-fit: cover;
			transform: scaleX(-1);
		}

		.camera-overlay-message {
			position: absolute;
			z-index: 20;
			color: var(--md-sys-color-surface-container-low);
			text-align: center;
			pointer-events: none;
			background: rgba(30, 30, 30, 0.6);
			padding: 32px;
			border-radius: var(--radius-large);
			backdrop-filter: blur(8px);
		}

		.camera-overlay-message .icon {
			font-size: 48px;
			margin-bottom: 16px;
			display: block;
			opacity: 0.8;
		}

		/* Camera Badge */
		.camera-badge {
			position: absolute;
			top: 24px;
			left: 24px;
			z-index: 30;
			background: red;
			color: white;
			font-size: 12px;
			font-weight: 500;
			padding: 8px 16px;
			border-radius: var(--radius-full);
			display: none;
			align-items: center;
			gap: 8px;
			letter-spacing: 0.5px;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
		}

		.camera-badge.live {
			display: flex;
		}

		.live-dot {
			width: 8px;
			height: 8px;
			background: white;
			border-radius: 50%;
			animation: blink 1s infinite;
		}

		@keyframes blink {
			50% {
				opacity: 0.5;
			}
		}

		/* ========================================= */
		/* RIGHT PANEL: CONTROLS & INFO              */
		/* ========================================= */
		.control-panel {
			width: 420px;
			padding: 8px;
			/* Internal padding handled by cards */
			display: flex;
			flex-direction: column;
			height: 100%;
			overflow-y: auto;
			gap: 16px;
			/* Hide scrollbar for cleaner look */
			scrollbar-width: none;
		}

		.control-panel::-webkit-scrollbar {
			display: none;
		}

		header {
			margin: 8px 4px 16px 4px;
		}


		h1 {
			font-family: 'Google Sans', sans-serif;
			font-size: 32px;
			font-weight: 400;
			color: var(--md-sys-color-on-surface);
			letter-spacing: -0.5px;
			line-height: 1.2;
		}

		.subtitle {
			font-size: 16px;
			color: var(--md-sys-color-on-surface-variant);
			margin-top: 8px;
			font-weight: 400;
		}

		/* M3 Cards (Filled Card Variant) */
		.card {
			background: var(--md-sys-color-surface-container);
			border: none;
			/* Removed border */
			padding: 24px;
			border-radius: var(--radius-large);
			transition: background 0.2s;
		}

		.card-title {
			font-size: 20px;
			/* Title Large */
			font-weight: 400;
			margin-bottom: 24px;
			color: var(--md-sys-color-on-surface);
			display: flex;
			align-items: center;
			gap: 12px;
		}

		/* Removed the blue pill bar before title for cleaner M3 look */
		.card-title::before {
			display: none;
		}

		/* Sensor Grid */
		.sensor-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 8px;
		}

		/* Sensor Chips */
		.sensor-card {
			background: var(--md-sys-color-surface);
			/* Contrast against card bg */
			border: 1px solid transparent;
			padding: 16px 8px;
			text-align: center;
			border-radius: var(--radius-medium);
			transition: all 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
		}

		/* Connected State = Primary Container */
		.sensor-card.connected {
			background: var(--md-sys-color-success-container);
			color: var(--md-sys-color-on-success-container);
		}

		.sensor-card.disconnected {
			background: var(--md-sys-color-surface-container-high);
			color: var(--md-sys-color-on-surface-variant);
			opacity: 1;
			/* M3 doesn't use opacity for disabled usually */
		}

		.sensor-icon {
			font-size: 24px;
			display: block;
			margin-bottom: 8px;
		}

		.sensor-name {
			font-size: 11px;
			font-weight: 700;
			letter-spacing: 0.5px;
			text-transform: uppercase;
		}

		.status-label {
			font-size: 12px;
			font-weight: 500;
			margin-top: 4px;
		}

		/* Buttons */
		.camera-controls {
			display: flex;
			gap: 12px;
			margin-bottom: 16px;
		}

		/* M3 Segmented Button / Tonal Button Style */
		.btn-camera {
			flex: 1;
			padding: 0 24px;
			height: 48px;
			font-size: 14px;
			font-weight: 500;
			border: none;
			background: var(--md-sys-color-secondary-container);
			color: var(--md-sys-color-on-secondary-container);
			cursor: pointer;
			border-radius: var(--radius-full);
			transition: background 0.2s;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
		}

		.btn-camera:hover {
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
		}

		.btn-camera-stop {
			background: var(--md-sys-color-error-container);
			color: var(--md-sys-color-on-error-container);
		}

		/* Filled Button (Primary) */
		.btn-primary {
			width: 100%;
			height: 48px;
			padding: 0 24px;
			background: var(--md-sys-color-primary);
			color: var(--md-sys-color-on-primary);
			border: none;
			font-family: 'Google Sans', sans-serif;
			font-weight: 500;
			font-size: 14px;
			letter-spacing: 0.25px;
			border-radius: var(--radius-full);
			cursor: pointer;
			margin-top: 24px;
			box-shadow: none;
			/* M3 relies on color weight mostly */
			transition: box-shadow 0.2s ease;
		}

		.btn-primary:hover {
			box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
			background: #004A77;
			/* Slight darken manually or use state layer */
		}

		/* Outlined Button */
		.btn-outline {
			background: transparent;
			color: var(--md-sys-color-primary);
			border: 1px solid var(--md-sys-color-outline);
			margin-top: 16px;
		}

		.btn-outline:hover {
			background: var(--md-sys-color-surface-container-high);
			border-color: var(--md-sys-color-primary);
		}

		/* Form Controls (M3 Text Fields) */
		.form-group {
			margin-bottom: 20px;
			position: relative;
		}

		label {
			font-size: 12px;
			font-weight: 500;
			color: var(--md-sys-color-on-surface-variant);
			margin-bottom: 8px;
			display: block;
			margin-left: 4px;
		}

		input {
			width: 100%;
			height: 56px;
			padding: 8px 16px;
			background: var(--md-sys-color-surface-container-high);
			border: 1px solid transparent;
			/* Filled text field style */
			border-bottom: 1px solid var(--md-sys-color-outline);
			color: var(--md-sys-color-on-surface);
			font-family: inherit;
			font-size: 16px;
			border-radius: 4px 4px 0 0;
			/* Traditional M3 Filled Input radius */
			transition: all 0.2s;
		}

		/* To make it "Expressive", let's use the fully rounded variant sometimes seen */
		input {
			border-radius: 12px;
			border: none;
		}

		input:focus {
			background: var(--md-sys-color-surface-container-high);
			outline: 2px solid var(--md-sys-color-primary);
			outline-offset: -2px;
		}

		/* Animation Area */
		.instruction-animation {
			width: 100%;
			height: 120px;
			background: var(--md-sys-color-surface-container-high);
			border-radius: var(--radius-medium);
			margin-bottom: 24px;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
		}

		.instruction-animation .circle-ripple {
			width: 24px;
			height: 24px;
			background: var(--md-sys-color-primary);
			border-radius: 50%;
			animation: pulse 1.5s cubic-bezier(0.2, 0, 0, 1) infinite;
			box-shadow: 0 0 0 0 rgba(11, 87, 208, 0.7);
		}

		@keyframes pulse {
			0% {
				transform: scale(0.95);
				box-shadow: 0 0 0 0 rgba(11, 87, 208, 0.7);
			}

			70% {
				transform: scale(1);
				box-shadow: 0 0 0 60px rgba(11, 87, 208, 0);
			}

			100% {
				transform: scale(0.95);
				box-shadow: 0 0 0 0 rgba(11, 87, 208, 0);
			}
		}

		.phase-instruction {
			font-size: 14px;
			color: var(--md-sys-color-on-surface-variant);
			line-height: 1.6;
			text-align: center;
		}

		.phase-instruction strong {
			color: var(--md-sys-color-on-surface);
			display: block;
			font-size: 18px;
			/* Headline Small */
			margin-bottom: 8px;
			font-weight: 500;
		}

		/* Alerts */
		.phase-alert {
			background: var(--md-sys-color-error-container);
			color: var(--md-sys-color-on-error-container);
			padding: 16px;
			border-radius: var(--radius-medium);
			font-size: 14px;
			font-weight: 500;
			margin-top: 16px;
			display: none;
			align-items: center;
			justify-content: center;
			gap: 12px;
			box-shadow: none;
		}

		.phase-alert.visible {
			display: flex;
		}

		/* Progress Stepper */
		.step-item {
			display: flex;
			align-items: center;
			gap: 16px;
			padding: 16px 12px;
			border-radius: 12px;
			/* Active background radius */
			font-size: 14px;
			color: var(--md-sys-color-on-surface-variant);
			font-weight: 500;
			transition: all 0.3s;
			border: none;
		}

		.step-item.active {
			background: var(--md-sys-color-surface-container-high);
			color: var(--md-sys-color-on-surface);
		}

		.step-circle {
			width: 28px;
			height: 28px;
			border-radius: 50%;
			background: var(--md-sys-color-surface-container-high);
			color: var(--md-sys-color-on-surface-variant);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 12px;
			font-weight: 700;
		}

		.step-item.active .step-circle {
			background: var(--md-sys-color-primary);
			color: var(--md-sys-color-on-primary);
		}

		.step-item.completed .step-circle {
			background: var(--md-sys-color-success-container);
			color: var(--md-sys-color-on-success-container);
			content: "‚úì";
		}

		/* Status Message Box */
		#statusMessage {
			margin-top: 16px;
			padding: 16px;
			border-radius: var(--radius-medium);
			background: var(--md-sys-color-primary-container) !important;
			color: var(--md-sys-color-on-primary-container) !important;
			font-weight: 500;
			font-size: 14px;
			display: flex;
			align-items: center;
			gap: 12px;
		}

		/* Responsive */
		@media (max-width: 900px) {
			body {
				flex-direction: column;
				overflow-y: auto;
				height: auto;
				padding: 12px;
			}

			.camera-panel {
				height: 50vh;
				min-height: 350px;
				width: 100%;
				margin: 0;
			}

			.control-panel {
				width: 100%;
				height: auto;
				overflow: visible;
				padding: 0;
			}
		}

		/* AI Overlay */
		.ai-processing-overlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.7);
			backdrop-filter: blur(16px);
			display: none;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			z-index: 50;
			color: white;
		}

		.ai-spinner {
			width: 56px;
			height: 56px;
			border: 6px solid rgba(255, 255, 255, 0.2);
			border-top: 6px solid var(--md-sys-color-primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin-bottom: 24px;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		/* Patient Context Modal */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.6);
			backdrop-filter: blur(8px);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.modal-overlay.visible {
			display: flex;
			opacity: 1;
		}

		.modal-content {
			background: var(--md-sys-color-surface);
			width: 90%;
			max-width: 400px;
			padding: 24px;
			border-radius: 28px;
			box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
			transform: scale(0.95);
			transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
		}

		.modal-overlay.visible .modal-content {
			transform: scale(1);
		}

		.modal-header {
			margin-bottom: 24px;
		}

		.modal-title {
			font-family: 'Google Sans', sans-serif;
			font-size: 24px;
			font-weight: 500;
			color: var(--md-sys-color-on-surface);
			margin-bottom: 8px;
		}

		.modal-subtitle {
			font-size: 14px;
			color: var(--md-sys-color-on-surface-variant);
			line-height: 1.5;
		}

		.context-form-group {
			margin-bottom: 20px;
		}

		.context-label {
			display: block;
			font-size: 12px;
			font-weight: 500;
			color: var(--md-sys-color-primary);
			margin-bottom: 8px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		.context-input,
		.context-select {
			width: 100%;
			padding: 12px 16px;
			border: 1px solid var(--md-sys-color-outline);
			border-radius: 8px;
			background: transparent;
			font-family: inherit;
			font-size: 16px;
			color: var(--md-sys-color-on-surface);
			transition: border-color 0.2s;
		}

		.context-input:focus,
		.context-select:focus {
			border-color: var(--md-sys-color-primary);
			outline: 2px solid var(--md-sys-color-primary-container);
		}

		.modal-actions {
			display: flex;
			justify-content: flex-end;
			gap: 12px;
			margin-top: 32px;
		}

		.btn-text {
			background: transparent;
			color: var(--md-sys-color-primary);
			border: none;
			padding: 10px 24px;
			border-radius: 24px;
			font-weight: 500;
			cursor: pointer;
		}

		.btn-text:hover {
			background: var(--md-sys-color-primary-container);
			opacity: 0.8;
		}

		.btn-primary {
			background: var(--md-sys-color-primary);
			color: var(--md-sys-color-on-primary);
			border: none;
			padding: 10px 24px;
			border-radius: 24px;
			font-weight: 500;
			cursor: pointer;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
		}

		.btn-primary:hover {
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
		}

		/* ============================================= */
		/* CONFIDENCE DASHBOARD                          */
		/* ============================================= */
		.conf-dashboard {
			display: none;
			margin-top: 16px;
		}

		.conf-dashboard.visible {
			display: block;
			animation: slideIn 0.4s cubic-bezier(0.2, 0, 0, 1);
		}

		@keyframes slideIn {
			from {
				opacity: 0;
				transform: translateY(12px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.conf-header {
			display: flex;
			align-items: center;
			gap: 10px;
			margin-bottom: 18px;
		}

		.conf-title {
			font-size: 16px;
			font-weight: 600;
			color: var(--md-sys-color-on-surface);
			flex: 1;
		}

		.conf-overall-badge {
			padding: 4px 14px;
			border-radius: 999px;
			font-size: 13px;
			font-weight: 700;
			letter-spacing: 0.3px;
		}

		/* Metric rows */
		.conf-metrics {
			display: flex;
			flex-direction: column;
			gap: 12px;
			margin-bottom: 18px;
		}

		.conf-metric-row {
			display: flex;
			flex-direction: column;
			gap: 4px;
		}

		.conf-metric-label-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.conf-metric-name {
			font-size: 13px;
			color: var(--md-sys-color-on-surface-variant);
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.conf-metric-pct {
			font-size: 13px;
			font-weight: 700;
			color: var(--md-sys-color-on-surface);
		}

		.conf-bar-track {
			height: 7px;
			background: var(--md-sys-color-surface-container-high);
			border-radius: 99px;
			overflow: hidden;
		}

		.conf-bar-fill {
			height: 100%;
			width: 0%;
			border-radius: 99px;
			transition: width 1.1s cubic-bezier(0.4, 0, 0.2, 1);
		}

		/* Divider */
		.conf-divider {
			height: 1px;
			background: var(--md-sys-color-outline-variant);
			margin: 14px 0;
		}

		/* Overall row (bigger bar + label) */
		.conf-overall-row {
			gap: 6px;
		}

		.conf-overall-row .conf-metric-name {
			font-size: 14px;
			font-weight: 600;
			color: var(--md-sys-color-on-surface);
		}

		.conf-overall-row .conf-bar-track {
			height: 10px;
		}

		/* Sensor live-value pills */
		.conf-sensors {
			display: flex;
			flex-direction: column;
			gap: 8px;
			margin-bottom: 14px;
		}

		.conf-sensor-row {
			display: flex;
			align-items: center;
			gap: 10px;
			font-size: 13px;
		}

		.conf-sensor-dot {
			width: 9px;
			height: 9px;
			border-radius: 50%;
			flex-shrink: 0;
		}

		.conf-sensor-name {
			flex: 1;
			color: var(--md-sys-color-on-surface-variant);
		}

		.conf-sensor-val {
			font-weight: 600;
			color: var(--md-sys-color-on-surface);
		}

		/* System heatmap */
		.conf-systems {
			display: flex;
			flex-wrap: wrap;
			gap: 6px;
			margin-bottom: 14px;
		}

		.conf-sys-chip {
			padding: 3px 10px;
			border-radius: 99px;
			font-size: 11px;
			font-weight: 600;
			letter-spacing: 0.2px;
			border: 1px solid transparent;
		}

		/* Warnings list */
		.conf-warnings {
			font-size: 12px;
			color: var(--md-sys-color-on-surface-variant);
			line-height: 1.6;
			padding: 10px 12px;
			background: var(--md-sys-color-surface);
			border-radius: 10px;
			border: 1px dashed var(--md-sys-color-outline-variant);
			margin-bottom: 12px;
			display: none;
		}

		.conf-warnings.visible {
			display: block;
		}

		/* Guidance box */
		.conf-guidance {
			font-size: 12px;
			color: var(--md-sys-color-on-surface-variant);
			line-height: 1.6;
			padding: 10px 12px;
			background: var(--md-sys-color-surface);
			border-radius: 10px;
			border: 1px dashed var(--md-sys-color-outline-variant);
		}
	</style>
</head>

<body>
	<!-- SIDEBAR -->
	<aside class="app-sidebar">
		<div class="logo-container">
			<div class="logo">Chiranjeevi</div>
		</div>

		<nav class="nav-menu">
			<a href="index.html" class="nav-item">
				<span class="nav-icon">üè†</span>
				<span class="nav-text">Home</span>
			</a>
			<a href="old_index.html" class="nav-item active">
				<span class="nav-icon">üî¨</span>
				<span class="nav-text">Screening</span>
			</a>
			<a href="chatbot.html" class="nav-item">
				<span class="nav-icon">üí¨</span>
				<span class="nav-text">CHIRANJEEVAI</span>
			</a>
		</nav>

		<div class="sidebar-footer">
			v2.0 ‚Ä¢ Unified Platform
		</div>
	</aside>

	<!-- MAIN CONTENT -->
	<main class="main-content" style="padding: 16px; display: flex; gap: 16px;">
		<!-- LEFT: CAMERA PANEL -->
		<div class="camera-panel" id="cameraPanel">
			<div class="camera-badge" id="liveBadge">
				<span class="live-dot"></span> LIVE
			</div>

			<div class="camera-overlay-message" id="cameraPlaceholder">
				<span class="icon">üì∑</span>
				<h2>Camera Feed Loading</h2>
				<p>Connecting to backend camera...</p>
			</div>

			<div class="ai-processing-overlay" id="aiOverlay">
				<div class="ai-spinner"></div>
				<h2 style="font-size: 24px; margin-bottom: 8px;">AI Analysis In Progress</h2>
				<p style="opacity: 0.9; font-size: 14px;">Generating comprehensive health report...</p>
			</div>

			<img id="cameraFeed" src="http://localhost:8000/api/v1/hardware/video-feed" style="display: none"
				alt="Live Camera Feed" />
		</div>

		<!-- RIGHT: CONTROLS PANEL -->
		<div class="control-panel">
			<header>
				<div class="logo-container">
					<div class="logo">Chiranjeevi</div>
				</div>
				<h1>Health Screening</h1>
				<p class="subtitle">Non-invasive AI health analysis</p>
			</header>

			<!-- DEBUG CONSOLE -->


			<!-- 1. SENSORS & CAMERA CONTROLS -->
			<div class="card">
				<h2 class="card-title">System Controls</h2>

				<div class="camera-controls">
					<button class="btn-camera btn-camera-start" id="startCameraBtn" onclick="toggleCamera()">
						‚ñ∂ Show Camera
					</button>
				</div>

				<div class="sensor-grid">
					<div class="sensor-card disconnected" id="sensorCamera">
						<span class="sensor-icon">üì∑</span>
						<div class="sensor-name">RGB</div>
						<div class="status-label">Disc.</div>
					</div>
					<div class="sensor-card disconnected" id="sensorEsp32">
						<span class="sensor-icon">üå°Ô∏è</span>
						<div class="sensor-name">Thermal</div>
						<div class="status-label">Disc.</div>
					</div>
					<div class="sensor-card disconnected" id="sensorRadar">
						<span class="sensor-icon">üì°</span>
						<div class="sensor-name">Radar</div>
						<div class="status-label">Disc.</div>
					</div>
				</div>

				<button class="btn-primary btn-outline" id="checkSensorsBtn" onclick="checkSensors()">
					Check Sensor Connectivity
				</button>
			</div>

			<!-- 2. CONFIGURATION FORM -->
			<div class="card" id="configCard">
				<h2 class="card-title">Configuration</h2>
				<form id="screeningForm">
					<div class="form-group">
						<label>Patient ID</label>
						<input type="text" id="patientId" value="PATIENT_001" />
					</div>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
						<div class="form-group">
							<label>Radar Port</label>
							<input type="text" id="radarPort" value="COM7" />
						</div>
						<div class="form-group">
							<label>Thermal Port</label>
							<input type="text" id="esp32Port" value="COM6" />
						</div>
					</div>
					<button type="submit" class="btn-primary" id="startBtn">
						Start Screening Flow
					</button>
				</form>
			</div>

			<!-- 3. SCREENING GUIDE -->
			<div class="card instruction-card">
				<h2 class="card-title">Screening Guide</h2>

				<div class="instruction-animation">
					<div class="circle-ripple"></div>
				</div>

				<div class="phase-instruction" id="phaseInstruction">
					<strong>Ready to Start</strong>
					Please ensure all sensors are connected. Stand in the center of the
					frame.
				</div>

				<div class="phase-alert" id="phaseAlert">
					<span id="phaseAlertIcon">‚ö†Ô∏è</span>
					<span id="phaseAlertText">Alert text here</span>
				</div>

				<div id="activeBiomarkers" style="margin-top: 16px; display: flex; flex-wrap: wrap; gap: 6px"></div>
			</div>

			<!-- 4. STATUS & RESULTS -->
			<div class="card status-card" id="statusCard" style="display: none">
				<h2 class="card-title">Status</h2>

				<div class="step-list" id="progressSteps">
					<div class="step-item" data-step="init">
						<div class="step-circle">1</div>
						Initializing
					</div>
					<div class="step-item" data-step="vitals">
						<div class="step-circle">2</div>
						Vitals Collection (10s)
					</div>
					<div class="step-item" data-step="baseline">
						<div class="step-circle">3</div>
						Baseline Calibration
					</div>
					<div class="step-item" data-step="capture">
						<div class="step-circle">4</div>
						Face Analysis (10s)
					</div>
					<div class="step-item" data-step="pose">
						<div class="step-circle">5</div>
						Body Analysis (10s)
					</div>
					<div class="step-item" data-step="process">
						<div class="step-circle">6</div>
						AI Processing
					</div>
				</div>

				<div id="statusMessage" style="
						padding: 12px;
						border-radius: 8px;
						background: rgba(99, 102, 241, 0.1);
						color: white;
						display: flex;
						gap: 10px;
						align-items: center;
						font-size: 14px;
					">
					<span>‚è≥</span> <span id="statusText">Waiting...</span>
				</div>

				<div id="downloadSection" style="margin-top: 16px; display: none; text-align: center;">
					<a href="#" class="btn-primary" id="downloadPatient" target="_blank" style="
							display: block;
							text-align: center;
							text-decoration: none;
							margin-bottom: 24px;
						">Download Patient Report (This Device)</a>

					<div id="qrContainer" style="
						background: var(--md-sys-color-surface); 
						padding: 24px; 
						border-radius: var(--radius-large); 
						display: inline-block;
						margin-bottom: 20px;
						border: 1px solid var(--md-sys-color-outline-variant);
						box-shadow: 0 8px 32px rgba(11, 87, 208, 0.08);
					">
						<div style="background: white; padding: 12px; border-radius: 12px; display: inline-block;">
							<img id="reportQr" src="" alt="Scan to download on mobile"
								style="width: 180px; height: 180px; display: block;" />
						</div>
						<p
							style="color: var(--md-sys-color-primary); font-size: 13px; margin-top: 16px; font-weight: 600; letter-spacing: 0.1px;">
							<span style="font-size: 16px; margin-right: 4px;">üì±</span> Scan to download on mobile
						</p>
					</div>
				</div>
			</div>

			<!-- 5. ASSESSMENT RELIABILITY DASHBOARD -->
			<div class="card conf-dashboard" id="trustCard">

				<!-- Header -->
				<div class="conf-header">
					<span id="confIcon" style="font-size:22px;">üõ°Ô∏è</span>
					<span class="conf-title">Assessment Reliability</span>
					<span class="conf-overall-badge" id="confBadge">--%</span>
				</div>

				<!-- Three sub-metric bars -->
				<div class="conf-metrics">

					<div class="conf-metric-row">
						<div class="conf-metric-label-row">
							<span class="conf-metric-name">üì∂ Signal Quality</span>
							<span class="conf-metric-pct" id="confSQ">--%</span>
						</div>
						<div class="conf-bar-track">
							<div class="conf-bar-fill" id="confSQBar"></div>
						</div>
					</div>

					<div class="conf-metric-row">
						<div class="conf-metric-label-row">
							<span class="conf-metric-name">üî¨ Data Plausibility</span>
							<span class="conf-metric-pct" id="confDP">--%</span>
						</div>
						<div class="conf-bar-track">
							<div class="conf-bar-fill" id="confDPBar"></div>
						</div>
					</div>

					<div class="conf-metric-row">
						<div class="conf-metric-label-row">
							<span class="conf-metric-name">üîó Cross-System</span>
							<span class="conf-metric-pct" id="confCS">--%</span>
						</div>
						<div class="conf-bar-track">
							<div class="conf-bar-fill" id="confCSBar"></div>
						</div>
					</div>

				</div>

				<div class="conf-divider"></div>

				<!-- Overall Trust (bigger bar) -->
				<div class="conf-metric-row conf-overall-row">
					<div class="conf-metric-label-row">
						<span class="conf-metric-name">Overall Trust</span>
						<span class="conf-metric-pct" id="confOT">--%</span>
					</div>
					<div class="conf-bar-track">
						<div class="conf-bar-fill" id="confOTBar"></div>
					</div>
				</div>

				<div class="conf-divider"></div>

				<!-- Sensor live-value rows -->
				<div class="conf-sensors" id="confSensorRows"></div>

				<!-- System reliability chips -->
				<div class="conf-systems" id="confSysChips"></div>

				<!-- Warnings -->
				<div class="conf-warnings" id="confWarnings"></div>

				<!-- Guidance -->
				<div class="conf-guidance" id="confGuidance"></div>

			</div>

			<div style="
					text-align: center;
					color: var(--text-secondary);
					font-size: 11px;
					margin-top: auto;
					padding-top: 20px;
				">
				Chiranjeevi v2.0 ‚Ä¢ Unified Architecture
			</div>
		</div>
	</main>

	<!-- PATIENT CONTEXT MODAL -->
	<div id="contextModal" class="modal-overlay">
		<div class="modal-content">
			<div class="modal-header">
				<div class="modal-title">Patient Profile</div>
				<div class="modal-subtitle">Help Chiranjeevi calibrate physiological baselines for higher accuracy.
				</div>
			</div>

			<div class="context-form-group">
				<label class="context-label">Age</label>
				<input type="number" id="ctxAge" class="context-input" value="30" min="5" max="100">
			</div>

			<div class="context-form-group">
				<label class="context-label">Gender</label>
				<select id="ctxGender" class="context-select">
					<option value="male">Male</option>
					<option value="female">Female</option>
					<option value="other">Other</option>
				</select>
			</div>

			<div class="context-form-group">
				<label class="context-label">Activity Level (Current)</label>
				<select id="ctxActivity" class="context-select">
					<option value="resting">Resting (seated >5 mins)</option>
					<option value="post_exercise">Post-Exercise / Active</option>
				</select>
			</div>

			<div class="modal-actions">
				<button class="btn-text" onclick="closeContextModal()">Cancel</button>
				<button class="btn-primary" onclick="confirmContextAndStart()">Start Scan</button>
			</div>
		</div>
	</div>

	<script>
		const API_BASE = "http://localhost:8000";
		let cameraShowing = false;
		let pollInterval = null;



		// ===== CAMERA TOGGLE (backend-owned MJPEG stream) =====
		function toggleCamera() {
			const feed = document.getElementById("cameraFeed");
			const placeholder = document.getElementById("cameraPlaceholder");
			const badge = document.getElementById("liveBadge");
			const btn = document.getElementById("startCameraBtn");

			if (!cameraShowing) {
				// Show MJPEG stream from backend
				feed.src = `${API_BASE}/api/v1/hardware/video-feed?t=${Date.now()}`;
				feed.style.display = "block";
				placeholder.style.display = "none";
				badge.style.display = "flex";
				btn.textContent = "‚èπ Hide Camera";
				btn.className = "btn-camera btn-camera-stop";
				cameraShowing = true;
				console.log("[info] Camera feed connected (backend MJPEG)");
			} else {
				// Hide stream (but backend keeps capturing)
				feed.style.display = "none";
				feed.src = "";
				placeholder.style.display = "flex";
				badge.style.display = "none";
				btn.textContent = "‚ñ∂ Show Camera";
				btn.className = "btn-camera btn-camera-start";
				cameraShowing = false;
				console.log("[info] Camera feed hidden (backend still capturing)");
			}
		}

		// ===== CHECK SENSORS =====
		async function checkSensors() {
			try {
				const res = await fetch(`${API_BASE}/api/v1/hardware/sensor-status`);
				const data = await res.json();

				updateSensorCard("sensorCamera", data.camera);
				updateSensorCard("sensorEsp32", data.esp32);
				updateSensorCard("sensorRadar", data.radar);
				console.log("[info] Sensor check complete");
			} catch (e) {
				console.error(`[error] Sensor check failed: ${e.message}`);
			}
		}

		function updateSensorCard(cardId, sensorData) {
			const card = document.getElementById(cardId);
			if (!card) return;
			const isConnected = sensorData.status === "connected";
			card.className = `sensor-card ${isConnected ? "connected" : "disconnected"}`;
			const label = card.querySelector(".status-label");
			if (label) label.textContent = isConnected ? "Online" : "Disc.";
		}

		// ===== PHASE UI =====
		function updatePhaseUI(phase, message) {
			const instruction = document.getElementById("phaseInstruction");
			const texts = {
				IDLE: [
					"SYSTEM READY",
					"Please ensure all sensors are connected. Stand in the center of the frame.",
				],
				INITIALIZING: ["INITIALIZING", "Preparing sensors for analysis..."],
				// Unified phase ‚Äî replaces old VITALS_COLLECTION + BASELINE_CALIBRATION + FACE_ANALYSIS
				FACE_AND_VITALS: [
					"FACE & VITALS SCAN",
					message || "Sit still and look at the camera. All sensors recording simultaneously for 30s.",
				],
				BODY_ANALYSIS: [
					"BODY ANALYSIS",
					message || "Analyzing posture and movement patterns...",
				],
				PROCESSING: [
					"AI DATA FUSION",
					message || "Running biomarker extraction and risk assessment...",
				],
				COMPLETE: [
					"SCREENING COMPLETE",
					"Your health report is ready for download.",
				],
				ERROR: ["ERROR", message || "An error occurred during screening."],
			};
			const [title, desc] = texts[phase] || [
				"PROCESSING",
				message || "Please wait...",
			];
			instruction.innerHTML = `<strong>${title}</strong> &nbsp;${desc}`;

			// Update biomarker tags
			const marks = {
				FACE_AND_VITALS: ["rPPG", "Radar HR", "Thermal", "Ocular", "Nasal", "Skin"],
				BODY_ANALYSIS: ["Skeletal", "Gait", "Posture", "Balance"],
				PROCESSING: ["Fusion", "Risk", "LLM", "Report"],
			};
			const tagList = marks[phase] || [];
			const html = tagList
				.map(
					(m) =>
						`<span style="background:#E8F0FE; border: 1px solid var(--accent-blue); padding:4px 8px; font-size:9px; font-weight:700; color:var(--accent-blue); border-radius:6px;">${m}</span>`,
				)
				.join("");
			document.getElementById("activeBiomarkers").innerHTML = html;

			// Update step progress
			// Steps simplified: init ‚Üí face_and_vitals ‚Üí body ‚Üí process ‚Üí done
			const stepMap = {
				INITIALIZING: "init",
				FACE_AND_VITALS: "capture",
				BODY_ANALYSIS: "pose",
				PROCESSING: "process",
				COMPLETE: "done",
			};
			const steps = ["init", "capture", "pose", "process"];
			const activeIdx = steps.indexOf(stepMap[phase] || "");
			document.querySelectorAll(".step-item").forEach((el, i) => {
				el.className = "step-item";
				if (i < activeIdx || phase === "COMPLETE")
					el.classList.add("completed");
				else if (i === activeIdx) el.classList.add("active");
			});

			// Toggle AI Overlay
			const aiOverlay = document.getElementById("aiOverlay");
			if (phase === "PROCESSING") {
				aiOverlay.style.display = "flex";
			} else {
				aiOverlay.style.display = "none";
			}
		}

		// ===== PATIENT CONTEXT MODAL LOGIC =====
		function openContextModal() {
			const modal = document.getElementById("contextModal");
			modal.classList.add("visible");
			// Focus age input
			setTimeout(() => document.getElementById("ctxAge").focus(), 100);
		}

		function closeContextModal() {
			document.getElementById("contextModal").classList.remove("visible");
		}

		function confirmContextAndStart() {
			const age = parseInt(document.getElementById("ctxAge").value) || 30;
			const gender = document.getElementById("ctxGender").value;
			const activity = document.getElementById("ctxActivity").value;

			const context = {
				age: age,
				gender: gender,
				activity_mode: activity
			};

			closeContextModal();
			// Call startScreening with the context, passing null for event
			startScreening(null, context);
		}

		// ===== START SCREENING =====
		async function startScreening(e, context = null) {
			console.log("Start button clicked");
			if (e) e.preventDefault();

			// Intercept: If no context, open modal first
			if (!context) {
				openContextModal();
				return;
			}

			// Show status card, hide config
			document.getElementById("statusCard").style.display = "block";
			document.getElementById("configCard").style.opacity = "0.5";
			document.getElementById("startBtn").disabled = true;
			document.getElementById("downloadSection").style.display = "none";

			// Ensure camera is visible
			if (!cameraShowing) toggleCamera();

			updatePhaseUI("INITIALIZING", "Preparing sensors...");
			document.getElementById("statusText").textContent = "Starting...";

			try {
				// Launch scan (non-blocking ‚Äî returns immediately)
				const body = {
					patient_id: document.getElementById("patientId").value,
					radar_port: document.getElementById("radarPort").value,
					esp32_port: document.getElementById("esp32Port").value,
					camera_index: 0,
					// Add Dynamic Validation Context
					age: context.age,
					gender: context.gender,
					activity_mode: context.activity_mode
				};

				console.log("Starting screening...");
				const res = await fetch(
					`${API_BASE}/api/v1/hardware/start-screening`,
					{
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(body),
					},
				);

				if (!res.ok) {
					const errData = await res.json();
					throw new Error(errData.detail || `Server error: ${res.status}`);
				}

				const data = await res.json();

				if (data.status === "error") {
					throw new Error(data.error || "Failed to start scan");
				}

				console.log("Scan started ‚Äî polling for progress...");

				// Start polling scan status
				pollScanStatus();
			} catch (e) {
				console.error(`Start error: ${e.message}`);
				document.getElementById("statusText").textContent =
					"Error: " + e.message;
				updatePhaseUI("ERROR", e.message);
				resetUI();
			}
		}

		// ===== POLL SCAN STATUS =====
		function pollScanStatus() {
			if (pollInterval) clearInterval(pollInterval);

			pollInterval = setInterval(async () => {
				try {
					const res = await fetch(`${API_BASE}/api/v1/hardware/scan-status`);
					const status = await res.json();

					// Update UI
					updatePhaseUI(status.phase, status.message);
					document.getElementById("statusText").textContent =
						`${status.message} (${status.progress}%)`;

					// Display distance / alignment warnings from backend (Logic Restoration)
					if (status.user_warnings) {
						const { distance_warning, face_detected, pose_detected } = status.user_warnings;
						const alertDiv = document.getElementById("phaseAlert");
						const alertIcon = document.getElementById("phaseAlertIcon");
						const alertText = document.getElementById("phaseAlertText");

						if (distance_warning === "too_close") {
							alertDiv.classList.add("visible");
							alertIcon.textContent = "‚ö†Ô∏è";
							alertText.textContent = "TOO CLOSE ‚Äî Move back from the camera";
						} else if (distance_warning === "too_far") {
							alertDiv.classList.add("visible");
							alertIcon.textContent = "‚ö†Ô∏è";
							alertText.textContent = "TOO FAR ‚Äî Move closer to the camera";
						} else if (status.phase === "FACE_ANALYSIS" && !face_detected) {
							alertDiv.classList.add("visible");
							alertIcon.textContent = "üë§";
							alertText.textContent = "FACE NOT DETECTED ‚Äî Center your face";
						} else if (status.phase === "BODY_ANALYSIS" && !pose_detected) {
							alertDiv.classList.add("visible");
							alertIcon.textContent = "üö∂";
							alertText.textContent = "BODY NOT DETECTED ‚Äî Step back until fully visible";
						} else {
							alertDiv.classList.remove("visible");
						}
					}

					// Check terminal states
					if (status.state === "complete") {
						clearInterval(pollInterval);
						pollInterval = null;
						onScanComplete(status);
					} else if (status.state === "error") {
						clearInterval(pollInterval);
						pollInterval = null;
						onScanError(status.message);
					}
				} catch (e) {
					console.error(`Poll error: ${e.message}`);
				}
			}, 500); // Poll every 500ms
		}

		// ===== SCAN COMPLETE =====
		function onScanComplete(status) {
			console.log("Screening complete!");
			updatePhaseUI("COMPLETE", "Screening complete!");
			document.getElementById("statusText").textContent =
				"‚úÖ Screening complete!";

			// Show download link and QR code
			if (status.patient_report_id) {
				document.getElementById("downloadPatient").href =
					`${API_BASE}/api/v1/reports/${status.patient_report_id}/download`;

				// Set QR code source
				document.getElementById("reportQr").src =
					`${API_BASE}/api/v1/reports/${status.patient_report_id}/qr?t=${Date.now()}`;

				document.getElementById("downloadSection").style.display = "block";
			}

			// CONFIDENCE DASHBOARD ‚Äî render trust_metadata
			if (status.trust_metadata) {
				const tm = status.trust_metadata;

				// ‚îÄ‚îÄ Colour helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
				function trustColor(v) {
					if (v >= 0.80) return { fg: '#0F9D58', bg: '#E6F4EA' }; // green
					if (v >= 0.55) return { fg: '#FBBC04', bg: '#FEF7E0' }; // amber
					return { fg: '#D93025', bg: '#FCE8E6' };       // red
				}

				function pct(v) { return Math.round((v || 0) * 100); }

				// ‚îÄ‚îÄ Fill progress bars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
				function fillBar(barId, labelId, value) {
					const p = pct(value);
					const c = trustColor(value);
					const bar = document.getElementById(barId);
					const lbl = document.getElementById(labelId);
					if (bar) { bar.style.width = p + '%'; bar.style.background = c.fg; }
					if (lbl) lbl.textContent = p + '%';
				}

				fillBar('confSQBar', 'confSQ', tm.data_quality_score);
				fillBar('confDPBar', 'confDP', tm.biomarker_plausibility);
				fillBar('confCSBar', 'confCS', tm.cross_system_consistency);
				fillBar('confOTBar', 'confOT', tm.overall_reliability);

				// ‚îÄ‚îÄ Overall badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
				const overall = tm.overall_reliability || 0;
				const oc = trustColor(overall);
				const badge = document.getElementById('confBadge');
				const icon = document.getElementById('confIcon');
				if (badge) {
					badge.textContent = pct(overall) + '%';
					badge.style.background = oc.bg;
					badge.style.color = oc.fg;
					badge.style.border = '1px solid ' + oc.fg + '60';
				}
				if (icon) icon.textContent = overall >= 0.80 ? '‚úÖ' : overall >= 0.55 ? '‚öñÔ∏è' : '‚ö†Ô∏è';

				// ‚îÄ‚îÄ Modality (sensor) live rows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
				const sensorRows = document.getElementById('confSensorRows');
				if (sensorRows && tm.modality_scores && Object.keys(tm.modality_scores).length > 0) {
					const SENSOR_META = {
						camera: { icon: 'üì∑', label: 'Camera (RGB)' },
						thermal: { icon: 'üå°Ô∏è', label: 'Thermal Sensor' },
						radar: { icon: 'üì°', label: 'Radar (60GHz)' },
						pose: { icon: 'üï∫', label: 'Pose Estimation' },
						face_landmarks: { icon: 'ü´•', label: 'Face Landmarks' },
					};
					sensorRows.innerHTML = Object.entries(tm.modality_scores).map(([key, val]) => {
						const meta = SENSOR_META[key] || { icon: 'üîß', label: key };
						const c = trustColor(val);
						const qual = val >= 0.80 ? 'High Quality' : val >= 0.55 ? 'Moderate Quality' : 'Low Quality';
						return `
							<div class="conf-sensor-row">
								<div class="conf-sensor-dot" style="background:${c.fg}"></div>
								<span style="font-size:15px;">${meta.icon}</span>
								<span class="conf-sensor-name">${meta.label}</span>
								<span class="conf-sensor-val" style="color:${c.fg}">${qual}</span>
							</div>`;
					}).join('');
				} else if (sensorRows) {
					// Fallback sensor rows from sensor-status already known
					sensorRows.innerHTML = `
						<div class="conf-sensor-row">
							<div class="conf-sensor-dot" style="background:#0F9D58"></div>
							<span style="font-size:15px;">üì∑</span>
							<span class="conf-sensor-name">Camera (RGB)</span>
							<span class="conf-sensor-val">${pct(tm.data_quality_score)}% quality</span>
						</div>`;
				}

				// ‚îÄ‚îÄ System reliability chips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
				const sysChips = document.getElementById('confSysChips');
				if (sysChips && tm.system_reliability && Object.keys(tm.system_reliability).length > 0) {
					sysChips.innerHTML = Object.entries(tm.system_reliability).map(([sys, val]) => {
						const c = trustColor(val);
						const name = sys.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
						return `<span class="conf-sys-chip" style="background:${c.bg};color:${c.fg};border-color:${c.fg}60;">${name} ${pct(val)}%</span>`;
					}).join('');
				}

				// ‚îÄ‚îÄ Warnings list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
				const warnBox = document.getElementById('confWarnings');
				if (warnBox) {
					const allWarnings = [
						...(tm.critical_issues || []),
						...(tm.warnings || []).slice(0, 3)
					];
					if (allWarnings.length > 0) {
						warnBox.innerHTML = '<strong>‚ö†Ô∏è Notices</strong><br>' +
							allWarnings.map(w => '‚Ä¢ ' + w).join('<br>');
						warnBox.classList.add('visible');
					}
				}

				// ‚îÄ‚îÄ Guidance box ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
				const guidanceBox = document.getElementById('confGuidance');
				if (guidanceBox) {
					guidanceBox.textContent = tm.interpretation_guidance ||
						'Data quality and biomarker validity are within acceptable ranges.';
				}

				// ‚îÄ‚îÄ Show dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
				const trustCard = document.getElementById('trustCard');
				if (trustCard) trustCard.classList.add('visible');
			}

			resetUI();
		}

		// ===== SCAN ERROR =====
		function onScanError(msg) {
			console.error(`Scan error: ${msg}`);
			updatePhaseUI("ERROR", msg);
			document.getElementById("statusText").textContent = "‚ùå Error: " + msg;
			resetUI();
		}

		// ===== RESET UI =====
		function resetUI() {
			document.getElementById("configCard").style.opacity = "1";
			document.getElementById("startBtn").disabled = false;
		}

		// ===== ERROR HANDLERS =====
		window.onerror = function (msg, url, line) {
			console.error(`JS Error: ${msg} (Line ${line})`);
			return false;
		};
		window.addEventListener("unhandledrejection", function (event) {
			console.error(`Promise Error: ${event.reason}`);
		});

		// ===== INIT =====
		window.onload = () => {
			// Wire form submit
			const form = document.getElementById("screeningForm");
			if (form) form.addEventListener("submit", startScreening);

			// Auto-connect camera and check sensors
			setTimeout(() => {
				checkSensors();
				toggleCamera(); // Auto-show MJPEG feed
				startContinuousWarningCheck(); // Start continuous distance warning polling
			}, 500);
		};

		// ===== CONTINUOUS WARNING CHECK =====
		let warningCheckInterval = null;
		function startContinuousWarningCheck() {
			// Poll status every 500ms to show distance warnings even before scan starts
			if (warningCheckInterval) clearInterval(warningCheckInterval);

			warningCheckInterval = setInterval(async () => {
				try {
					const res = await fetch(`${API_BASE}/api/v1/hardware/scan-status`);
					const status = await res.json();

					// Only update warnings if not actively scanning (to avoid conflict with pollScanStatus)
					if (status.state === "idle" || status.state === "complete") {
						if (status.user_warnings) {
							const { distance_warning, face_detected } =
								status.user_warnings;
							const alertDiv = document.getElementById("phaseAlert");
							const alertIcon = document.getElementById("phaseAlertIcon");
							const alertText = document.getElementById("phaseAlertText");

							const { quality_ok, brightness } = status.user_warnings;
							if (distance_warning === "too_close") {
								alertDiv.classList.add("visible");
								alertIcon.textContent = "‚ö†Ô∏è";
								alertText.textContent =
									"TOO CLOSE ‚Äî Please move back from the camera";
							} else if (distance_warning === "too_far") {
								alertDiv.classList.add("visible");
								alertIcon.textContent = "‚ö†Ô∏è";
								alertText.textContent =
									"TOO FAR ‚Äî Please move closer to the camera";
							} else if (!face_detected) {
								alertDiv.classList.add("visible");
								alertIcon.textContent = "üë§";
								alertText.textContent =
									"NO FACE DETECTED ‚Äî Position yourself in frame";
							} else if (quality_ok === false) {
								alertDiv.classList.add("visible");
								alertIcon.textContent = "üí°";
								const b = brightness ? ` (brightness: ${Math.round(brightness)}/255)` : '';
								alertText.textContent = `POOR SIGNAL QUALITY ‚Äî Improve lighting or hold still${b}`;
							} else {
								alertDiv.classList.remove("visible");
							}
						}
					}
				} catch (e) {
					// Silent fail for continuous check
				}
			}, 500);
		}
	</script>
</body>

</html>